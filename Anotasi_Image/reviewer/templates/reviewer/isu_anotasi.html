{% extends 'base_reviewer.html' %} 
{% block style %}
{% endblock %}

{% block extra_js %}
<script>
function finishReview() {
    const imageId = {{ gambar_id }};
    const profileId = {{ profile_id }};
    
    if (confirm('Apakah Anda yakin ingin menyelesaikan review untuk gambar ini?')) {
        fetch(`/reviewer/finish_review/${imageId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                if (data.job_completed) {
                    alert('Semua gambar telah selesai direview. Job telah diselesaikan!');
                    window.location.href = `/reviewer/task_review/${profileId}/`;
                } else {
                    // Navigate to next image or back to task review
                    const nextIndex = {{ image_index }};
                    const totalImages = {{ total_images }};
                    if (nextIndex < totalImages) {
                        window.location.href = `/reviewer/isu_anotasi/${nextIndex}/?profile_id=${profileId}`;
                    } else {
                        window.location.href = `/reviewer/task_review/${profileId}/`;
                    }
                }
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat menyelesaikan review.');
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

{% block content-header %}
<div class="d-flex align-items-center"> 
  <div>
    <a href="{% url 'reviewer:task_review' profile_id %}" class="">
      <span style="color: white;">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
          <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l6 6m-6-6l6-6"/>
        </svg>
      </span>
    </a>
  </div>
  <div>
    <div class="d-flex">
      <span class="text-white">{{ nama_profile_job }}</span>
      <span class="ps-1 pe-1 text-white"></span>
      <div class="d-flex">
        <span style="color: white;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 100 100">
            <path fill="currentColor" d="M82.488 68.439V31.561a10.41 10.41 0 0 0 5.424-9.143c0-5.753-4.664-10.417-10.417-10.417a10.4 10.4 0 0 0-8.577 4.512H31.083a10.4 10.4 0 0 0-8.577-4.512c-5.753 0-10.417 4.664-10.417 10.417c0 3.944 2.192 7.375 5.424 9.143v36.877a10.41 10.41 0 0 0-5.424 9.143c0 5.753 4.664 10.417 10.417 10.417c4.371 0 8.107-2.695 9.653-6.512h35.682c1.546 3.816 5.282 6.512 9.653 6.512c5.753 0 10.417-4.664 10.417-10.417c0-3.943-2.192-7.373-5.423-9.142m-55-.007V31.568a10.46 10.46 0 0 0 4.61-5.081h35.806a10.46 10.46 0 0 0 4.61 5.081v36.864a10.46 10.46 0 0 0-3.473 3.081h-38.08a10.45 10.45 0 0 0-3.473-3.081"/>
          </svg>
        </span>
        <span class="text-white">Labeling</span>
      </div>
    </div>
    <div class="d-flex">
      <span class="text-white">{{ filename }}</span>
    </div>
  </div>
  <div class="d-flex align-items-end ms-5 pb-1 h-100">
    <div>
      <span id="zoomIn" style="color: white; cursor: pointer;">
        <!-- Zoom In -->
         <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
          <path fill="currentColor" d="M18 12h-4V8h-2v4H8v2h4v4h2v-4h4z"/><path fill="currentColor" d="M21.448 20A10.86 10.86 0 0 0 24 13a11 11 0 1 0-11 11a10.86 10.86 0 0 0 7-2.552L27.586 29L29 27.586ZM13 22a9 9 0 1 1 9-9a9.01 9.01 0 0 1-9 9"/>
        </svg>
      </span>
    </div>
    <div class="ms-3">
      <span id="zoomOut" style="color: white; cursor: pointer;">
        <!-- Zoom Out -->
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
          <path fill="currentColor" d="M8 12h10v2H8z"/><path fill="currentColor" d="M21.448 20A10.86 10.86 0 0 0 24 13a11 11 0 1 0-11 11a10.86 10.86 0 0 0 7-2.552L27.586 29L29 27.586ZM13 22a9 9 0 1 1 9-9a9.01 9.01 0 0 1-9 9"/>
        </svg>
      </span>
    </div>
    <div class="ms-1">
      <span id="zoomFit" style="color: white; cursor: pointer;">
        <!-- Zoom Fit -->
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
          <path fill="currentColor" d="M21.448 20A10.86 10.86 0 0 0 24 13a11 11 0 1 0-11 11a10.86 10.86 0 0 0 7-2.552L27.586 29L29 27.586ZM13 22a9 9 0 1 1 9-9a9.01 9.01 0 0 1-9 9"/><path fill="currentColor" d="M10 12H8v-2a2 2 0 0 1 2-2h2v2h-2zm8 0h-2v-2h-2V8h2a2 2 0 0 1 2 2zm-6 6h-2a2 2 0 0 1-2-2v-2h2v2h2zm4 0h-2v-2h2v-2h2v2a2 2 0 0 1-2 2"/>
        </svg>
      </span>
    </div>
  </div>
  <div class="d-flex w-100 justify-content-center">
    <div class="rounded" style="background-color:rgba(87,180,206,0.1);">
      <div class="d-flex justify-content-senter align-items-center" style="font-size: 1.2rem;" >
        <div class="btn" id="prevBtn">
          <span style="color: white;">
            <a href="{% if image_index > 1 %}{% url 'reviewer:isu_anotasi' image_index|add:'-2' %}?profile_id={{ profile_id }}{% else %}#{% endif %}  " id="prevBtn" class="text-secondary text-decoration-none"> 
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <path fill="#ffffff" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14 7l-5 5m0 0l5 5"/>
            </svg>
            </a>
          </span>
        </div>
        <div class="ms-3 me-3 text-center text-white" id="pageInfo" style="width: 60px;">{{ image_index }} / {{ total_images }}</div>
        <div class=" btn justify-content-senter align-items-center" id="nextBtn" style="height: 40px;">
          <span style="color: white;">
            <a href="{% if image_index < total_images %}{% url 'reviewer:isu_anotasi' image_index %}?profile_id={{ profile_id }}{% else %}#{% endif %}" id="nextBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <path fill="#ffffff" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m10 17l5-5m0 0l-5-5"/>
            </svg>
            </a>
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="ms-auto">
    <button class="btn btn-primary text-white p-0 me-2" style="width: 100px; height: 30px;" onclick="finishReview()">Finish</button>
  </div>
</div>

{% endblock %}

{% block sidebar %}
<div class="ms-2 ps-0 pe-0 border-end border-dark d-flex flex-column" style="width: 200px;">
    <div>
        <a href="{% url 'reviewer:isu' %}" class="mt-2 w-100 text-dark text-decoration-none d-flex align-items-center pe-2 ps-2" type="button">
            <img src="{{ nav_isu_base64 }}" alt="nav_isu" class="me-2">
            Isu
        </a>
    </div>
    <div>
        <a href="" class="mt-2 pt-1 pb-1 border border-dark rounded w-100 text-dark text-decoration-none d-flex align-items-center pe-2 ps-2" type="button">
            <img src="{{ nav_proses_base64 }}" alt="nav_proses" class="me-2">
            Proses Review
        </a>
    </div>
    <div class="" >
        <a href="{% url 'reviewer:home_reviewer' %}" class="mt-2 mb-2 pt-1 pb-1 w-100 text-dark text-decoration-none d-flex align-items-center pe-2 ps-2" type="button">
            <img src="{{ nav_notif_base64 }}" alt="nav_notif" class="me-2">
            Notifications
        </a>
    </div>
    <div class="w-100 mt-auto">
        <div class="d-flex align-items-center  pt-2 pb-2 ps-1 pe-2 " style="width: fit-content;">
            <div class="d-flex justify-content-center align-items-center " style="width: 35px; height: 35px;">
                <img src="{{ nav_username_base64 }}" alt="user" style="width: 100%; height: auto;">
            </div>
            <div class="flex-grow-1 ps-1">
                <p class="mb-0 fw-bold">{{ username }}</p>
                <div class="scroll-hidden">
                    <p class="mb-0 text-muted" style="font-size: 12px; min-width: max-content;">{{ number_email }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content1 %}
<div class="d-flex">
  <div class="p-0 border-end" style="width: 180px; gap: 20px">
    <div class="border-end">
      <p class="mt-2 ps-2">Annotations</p>
      <p class="text-center border-bottom" style="text-decoration: underline; text-decoration-color: red; text-decoration-thickness: 4px;">CLASSES</p>
      <div>
        <div class="">
          <div class="input-group rounded">
            <input type="search" class="form-control rounded" placeholder="Search" aria-label="Search" aria-describedby="search-addon" />
            <span class="input-group-text border-0" id="search-addon"><i class="fas fa-search"></i></span>
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>
      {% for segmentasi in segmentasi_list %}
      <div class="d-flex align-items-center border" style="width: 100%">
        <div class="ps-2">{{ segmentasi.label }}</div>
        <div class="ms-auto badge text-dark text me-1" style="background-color: #d4d4d4">{{ forloop.counter }}</div>
      </div>
      {% endfor %}
    </div>
    <div style="height: 50px"></div>
    <div class="">
      <p class="text-center border border-end-0 pt-2" style="text-decoration: underline; text-decoration-color: red; text-decoration-thickness: 4px;">SEGMENTATION TYPE</p>
      <div class="">
        <div class="">
          <div class="d-flex align-items-center p-0 collapse-toggle" data-target="#kontensemantic" data-label="#labelsemantic" data-icon="#iconsemantic" data-eye="#eyesemantic" data-mode="semantic" role="button" tabindex="0" data-bs-toggle="collapse" data-bs-target="#kontensemantic" aria-expanded="false">
            <span class="m-0 me-2" >
              <span id="iconsemantic">
                <span class="icon-show" style="display: inline;">{% include "icons/arrow-down.html" %}</span>
                <span class="icon-hide" style="display: none;">{% include "icons/arrow-right.html" %}</span>
              </span>
            </span>
            <p id="labelsemantic" class="p-0 m-0">Semantic ({{ total_semantic }})</p>
            <span id="eyesemantic" class="ms-auto">
              <span class="eye-show" style="display: inline;">{% include "icons/eye-show.html" %}</span>
              <span class="eye-hide" style="display: none;">{% include "icons/eye-hide.html" %}</span>
            </span>
          </div>
          <div class="collapse" id="kontensemantic">
            <ul class="list-group list-group-flush">
              {% for poly in polygon_semantic_list %}
              <li class="list-group-item d-flex align-items-center justify-content-between p-0">
                <div class="d-flex align-items-center ps-1">
                  <span class="me-2" style="color: {{ poly.warna }}">
                    {% include "icons/polygon.html" %}
                  </span>
                  <span>{{ poly.label }}</span>
                </div>
                <div>
                  <span style="color: #f6d35c">●</span>
                  <span class="m-0 p-0">
                    {% include "icons/eye-show.html" %}
                  </span>
                  <div class="btn-group dropend">
                    <span type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      {% include "icons/three-dot.html" %}
                    </span>
                    <ul class="dropdown-menu p-0">
                      <li class="dropdown-item">
                        <a class="text-decoration-none" href="#">
                          <span style="color: red;">
                            {% include "icons/delete.html" %}
                          </span>
                          <span class="text-danger h6-font-size">Delete</span>
                        </a>
                      </li>
                      <li>
                        <div class="dropend">
                          <a class="dropdown-item text-decoration-none text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <span>
                              {% include "icons/change-circle.html" %}
                            </span>
                            <span>Change Class</span>
                          </a>
                          <ul class="dropdown-menu p-0">
                            <div class="d-flex justify-content-center p-0 m-0 text-white" style="background-color: #0F84D0;width: 100%;"><span>Class Editor</span></div>
                            {% for segmentasi in segmentasi_list %}
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">{{ forloop.counter }}</div>
                                <div class="ps-2">{{ segmentasi.label }}</div>
                              </a>
                            </li>
                            {% endfor %}
                          </ul>
                        </div>
                      </li>
                      <li class="dropdown-item">
                        <a class="text-decoration-none text-dark" href="#">
                          <span>
                            {% include "icons/git-isu.html" %}
                          </span>
                          <span>Make Issue</span>
                        </a>
                      </li>
                      <li class="dropdown-item">
                        <a class="text-decoration-none text-dark" href="#">
                          <span>
                            {% include "icons/copy-fill.html" %}
                          </span>
                          <span>Copy</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </li>
              {% empty %}
              <li class="list-group-item text-muted text-center p-2">
                No semantic annotations found
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="">
          <div class="d-flex align-items-center p-0 collapse-toggle" data-target="#konteninstance" data-label="#labelinstance" data-icon="#iconinstance" data-eye="#eyeinstance" data-mode="instance" role="button" tabindex="0" data-bs-toggle="collapse" data-bs-target="#konteninstance" aria-expanded="false">
            <span class="m-0 me-2" >
              <span id="iconinstance">
                <span class="icon-show" style="display: inline;">{% include "icons/arrow-down.html" %}</span>
                <span class="icon-hide" style="display: none;">{% include "icons/arrow-right.html" %}</span>
              </span>
            </span>
            <p id="labelinstance" class="p-0 m-0">Instance ({{ total_instance }})</p>
            <span id="eyeinstance" class="ms-auto">
              <span class="eye-show" style="display: inline;">{% include "icons/eye-show.html" %}</span>
              <span class="eye-hide" style="display: none;">{% include "icons/eye-hide.html" %}</span>
            </span>
          </div>
          <div class="collapse" id="konteninstance">
            <ul class="list-group list-group-flush">
              {% for item in segmentasi_anotasi_info %}
              <li class="list-group-item d-flex align-items-center justify-content-between p-0">
                <div class="d-flex align-items-center ps-1">
                  <span class="me-2" style="color: {{ item.warna }}">
                    {% include "icons/rectangle.html" %}
                  </span>
                  <span>{{ item.nama }}</span>
                </div>
                <div>
                  <span style="color: #f6d35c">●</span>
                  <span class="eye-show" id="eye-show-{{ item.id }}" data-id="{{ item.id }}" 
                        style="display:inline; cursor: pointer;">
                    {% include "icons/eye-show.html" %}
                  </span>
                  <span class="eye-hide" id="eye-hide-{{ item.id }}" data-id="{{ item.id }}" 
                        style="display:none; cursor: pointer;">
                    {% include "icons/eye-hide.html" %}
                  </span>
                  <div class="btn-group dropend">
                    <span type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      {% include "icons/three-dot.html" %}
                    </span>
                    <ul class="dropdown-menu p-0">
                      <li class="dropdown-item">
                        <a class="text-decoration-none" href="#">
                          <span style="color: red;">
                            {% include "icons/delete.html" %}
                          </span>
                          <span class="text-danger h6-font-size">Delete</span>
                        </a>
                      </li>
                      <li>
                        <div class="dropend">
                          <a class="dropdown-item text-decoration-none text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <span>
                              {% include "icons/change-circle.html" %}
                            </span>
                            <span>Change Class</span>
                          </a>
                          <ul class="dropdown-menu p-0">
                            <div class="d-flex justify-content-center p-0 m-0 text-white" style="background-color: #0F84D0;width: 100%;"><span>Class Editor</span></div>
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">1</div>
                                <div class="ps-2">mobil</div>
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">2</div>
                                <div class="ps-2">motor</div>
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">3</div>
                                <div class="ps-2">truk</div>
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">4</div>
                                <div class="ps-2">bus</div>
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">5</div>
                                <div class="ps-2">kereta</div>
                              </a>
                            </li>
                          </ul>
                        </div>
                      </li>
                      <li class="dropdown-item">
                        <a class="text-decoration-none text-dark" href="#">
                          <span>
                            {% include "icons/git-isu.html" %}
                          </span>
                          <span>Make Issue</span>
                        </a>
                      </li>
                      <li class="dropdown-item">
                        <a class="text-decoration-none text-dark" href="#">
                          <span>
                            {% include "icons/copy-fill.html" %}
                          </span>
                          <span>Copy</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="">
          <div class="d-flex align-items-center p-0 collapse-toggle" data-target="#kontenpanoptic" data-label="#labelpanoptic" data-icon="#iconpanoptic" data-eye="#eyepanoptic" data-mode="panoptic" role="button" tabindex="0" data-bs-toggle="collapse" data-bs-target="#kontenpanoptic" aria-expanded="false">
            <span class="m-0 me-2" >
              <span id="iconpanoptic">
                <span class="icon-show" style="display: inline;">{% include "icons/arrow-down.html" %}</span>
                <span class="icon-hide" style="display: none;">{% include "icons/arrow-right.html" %}</span>
              </span>
            </span>
            <p id="labelpanoptic" class="p-0 m-0">Panoptic ({{ total_panoptic }})</p>
            <span id="eyepanoptic" class="ms-auto">
              <span class="eye-show" style="display: inline;">{% include "icons/eye-show.html" %}</span>
              <span class="eye-hide" style="display: none;">{% include "icons/eye-hide.html" %}</span>
            </span>
          </div>
          <div class="collapse" id="kontenpanoptic">
            <ul class="list-group list-group-flush">
              {% for poly in polygon_panoptic_list %}
              <li class="list-group-item d-flex align-items-center justify-content-between p-0">
                <div class="d-flex align-items-center ps-1">
                  <span class="me-2" style="color: {{ poly.warna }}">
                    {% include "icons/polygon.html" %}
                  </span>
                  <span>{{ poly.label }}</span>
                </div>
                <div>
                  <span style="color: #f6d35c">●</span>
                  <span class="m-0 p-0">
                    {% include "icons/eye-show.html" %}
                  </span>
                  <div class="btn-group dropend">
                    <span type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      {% include "icons/three-dot.html" %}
                    </span>
                    <ul class="dropdown-menu p-0">
                      <li class="dropdown-item">
                        <a class="text-decoration-none" href="#">
                          <span style="color: red;">
                            {% include "icons/delete.html" %}
                          </span>
                          <span class="text-danger h6-font-size">Delete</span>
                        </a>
                      </li>
                      <li>
                        <div class="dropend">
                          <a class="dropdown-item text-decoration-none text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <span>
                              {% include "icons/change-circle.html" %}
                            </span>
                            <span>Change Class</span>
                          </a>
                          <ul class="dropdown-menu p-0">
                            <div class="d-flex justify-content-center p-0 m-0 text-white" style="background-color: #0F84D0;width: 100%;"><span>Class Editor</span></div>
                            {% for segmentasi in segmentasi_list %}
                            <li>
                              <a class="dropdown-item d-flex align-items-center" href="#">
                                <div class="badge text-dark" style="background-color: #d4d4d4">{{ forloop.counter }}</div>
                                <div class="ps-2">{{ segmentasi.label }}</div>
                              </a>
                            </li>
                            {% endfor %}
                          </ul>
                        </div>
                      </li>
                      <li class="dropdown-item">
                        <a class="text-decoration-none text-dark" href="#">
                          <span>
                            {% include "icons/git-isu.html" %}
                          </span>
                          <span>Make Issue</span>
                        </a>
                      </li>
                      <li class="dropdown-item">
                        <a class="text-decoration-none text-dark" href="#">
                          <span>
                            {% include "icons/copy-fill.html" %}
                          </span>
                          <span>Copy</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </li>
              {% empty %}
              <li class="list-group-item text-muted text-center p-2">
                No panoptic annotations found
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="flex-grow-1">
    <div>
      <div class="d-flex gap-1 flex-wrap" style="white-space: nowrap;">
        <div class="d-flex justify-content-center align-items-center text-center rounded p-4 min-w-150 flex-fill">
          <div class="rounded d-flex flex-column justify-content-center align-items-center" style="background-color: rgba(150,182,190,0.4); height: 100px; width: 150px;">
            <div class="fs-4 fw-bold">{{ unannotated_count }}</div>
            <div class="small text-muted">Unannotated</div>
          </div>
        </div>
        <div class="d-flex justify-content-center align-items-center text-center rounded p-4 min-w-150 flex-fill">
          <div class="rounded d-flex flex-column justify-content-center align-items-center" style="background-color: rgba(150,182,190,0.4); height: 100px; width: 150px;">
            <div class="fs-4 fw-bold">{{ in_review_count }}</div>
            <div class="small text-muted">In Review</div>
          </div>
        </div>
        <div class="d-flex justify-content-center align-items-center text-center rounded p-4 min-w-150 flex-fill">
          <div class="rounded d-flex flex-column justify-content-center align-items-center" style="background-color: rgba(150,182,190,0.4); height: 100px; width: 150px;">
            <div class="fs-4 fw-bold">{{ in_rework_count }}</div>
            <div class="small text-muted">In Rework</div>
          </div>
        </div>
        <div class="d-flex justify-content-center align-items-center text-center rounded p-4 min-w-150 flex-fill">
          <div class="rounded d-flex flex-column justify-content-center align-items-center" style="background-color: rgba(150,182,190,0.4); height: 100px; width: 150px;">
            <div class="fs-4 fw-bold">{{ finished_count }}</div>
            <div class="small text-muted">Finished</div>
          </div>
        </div>
        <div class="d-flex justify-content-center align-items-center text-center rounded p-4 min-w-150 flex-fill">
          <div class="rounded d-flex flex-column justify-content-center align-items-center" style="background-color: rgba(150,182,190,0.4); height: 100px; width: 150px;">
            <div class="fs-4 fw-bold">{{ issues_count }}</div>
            <div class="small text-muted">Issues</div>
          </div>
        </div>
      </div>
      <div class="bg-secondary w-100">
        <div class="">
          <div id="zoomWrapper" style="width: 100%; height: 580px; overflow: auto; border: 1px solid #ccc; position: relative;">
            <img id="zoomImage" src="{{ gambar.url }}" alt="Gambar"
                style="display: block; transform-origin: top left; max-width: 100%; max-height: 100%; width: auto; height: auto;">
            <!-- Canvas for bounding box rendering -->
            <canvas id="annotationCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10;"></canvas>
<svg id="svgSemantic" width="{{ lebar_gambar }}" height="{{ tinggi_gambar }}"
     style="position: absolute; top: 0; left: 0;">
    {% for poly in polygon_semantic_list %}
      <g class="semantic-group">
        <!-- polygon -->
        <polygon 
          class="semantic-polygon"
          points="{{ poly.points }}"
          fill="{{ poly.warna }}"
          fill-opacity="0.4"
          stroke="{{ poly.warna }}"
          stroke-width="2">
          <title>{{ poly.label }}</title>
        </polygon>

        <!-- background label (sementara width=50, nanti diubah JS) -->
        <rect 
          class="label-bg"
          data-label="{{ poly.label }}"
          data-color="{{ poly.warna }}"
          x="{{ poly.min_x }}" 
          y="{{ poly.min_y|add:-18 }}" 
          width="50" height="18" 
          rx="3" ry="3"/>

        <!-- teks label -->
        <text 
          class="label-text"
          x="{{ poly.min_x|add:4 }}" 
          y="{{ poly.min_y|add:-5 }}" 
          font-size="13" font-weight="bold" fill="white">
          {{ poly.label }}
        </text>
      </g>
    {% endfor %}
</svg>
<svg id="svgInstance" width="{{ lebar_gambar }}" height="{{ tinggi_gambar }}"
     style="position: absolute; top: 0; left: 0;">
    {% for anotasi in anotasi_box %}
      <g class="bbox-group">
        <rect 
          class="bbox"
          x="{{ anotasi.x_coordinate }}" 
          y="{{ anotasi.y_coordinate }}" 
          width="{{ anotasi.width }}" 
          height="{{ anotasi.height }}" 
          fill="none" 
          stroke="{{ anotasi.segmentation.color }}" 
          stroke-width="2"/>

        <!-- background label, width akan diupdate JS -->
        <rect 
          class="label-bg"
          data-label="{{ anotasi.segmentation.label }}"
          data-color="{{ anotasi.segmentation.color }}"
          x="{{ anotasi.x_coordinate }}" 
          y="{{ anotasi.y_coordinate|add:-18 }}" 
          width="50" height="18" 
          rx="3" ry="3"/>

        <text 
          class="label-text"
          x="{{ anotasi.x_coordinate|add:4 }}" 
          y="{{ anotasi.y_coordinate|add:-5 }}" 
          font-size="13" font-weight="bold" fill="white">
          {{ anotasi.segmentation.label }}
        </text>
      </g>
    {% endfor %}
</svg>
            <svg id="svgPanoptic" width="{{ lebar_gambar }}" height="{{ tinggi_gambar }}"
     style="position: absolute; top: 0; left: 0;">
    {% for poly in panoptic_list %}
      <g class="panoptic-group">
        <!-- polygon -->
        <polygon 
          points="{{ poly.points }}"
          fill="{{ poly.fill }}"
          stroke="{{ poly.stroke }}"
          stroke-width="2" 
          fill-opacity="0.3">
        </polygon>

        <!-- background label -->
        <rect 
          class="label-bg"
          data-label="{{ poly.label }}"
          data-color="{{ poly.fill }}"
          x="{{ poly.min_x }}" 
          y="{{ poly.min_y|add:-18 }}" 
          width="50" 
          height="18" 
          rx="3" ry="3"/>

        <!-- teks label -->
        <text 
          class="label-text"
          x="{{ poly.min_x|add:4 }}" 
          y="{{ poly.min_y|add:-5 }}" 
          font-size="13" font-weight="bold" fill="white">
          {{ poly.label }}
        </text>
      </g>
    {% endfor %}
</svg>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>


{% endblock %}

{% block scriptjs %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggles = document.querySelectorAll('.collapse-toggle');

  const svgSemantic = document.getElementById("svgSemantic");
  const svgInstance = document.getElementById("svgInstance");
  const svgPanoptic = document.getElementById("svgPanoptic");

  // =======================
  // 1. Eye Utama (Group Besar)
  // =======================
  toggles.forEach(toggleGroup => {
    const collapseId = toggleGroup.getAttribute('data-target');
    const labelSelector = toggleGroup.getAttribute('data-label');
    const iconSelector = toggleGroup.getAttribute('data-icon');
    const eyeSelector = toggleGroup.getAttribute('data-eye');
    const mode = toggleGroup.getAttribute('data-mode');

    const collapseEl = document.querySelector(collapseId);
    const labelEl = document.querySelector(labelSelector);
    const iconContainer = document.querySelector(iconSelector);
    const eyeContainer = document.querySelector(eyeSelector);

    const iconShow = iconContainer.querySelector('.icon-show');
    const iconHide = iconContainer.querySelector('.icon-hide');
    const eyeShow = eyeContainer.querySelector('.eye-show');
    const eyeHide = eyeContainer.querySelector('.eye-hide');

    // Inisialisasi status awal
    if (collapseEl.classList.contains('show')) {
      labelEl.classList.remove('text-muted');
      labelEl.classList.add('text-dark');
      iconShow.style.display = 'inline';
      iconHide.style.display = 'none';
      eyeShow.style.display = 'inline';
      eyeHide.style.display = 'none';

      if (mode === "semantic") {
        svgSemantic.style.display = 'inline';
        svgInstance.style.display = 'none';
        svgPanoptic.style.display = 'none';
      } else if (mode === "instance") {
        svgSemantic.style.display = 'none';
        svgInstance.style.display = 'inline';
        svgPanoptic.style.display = 'none';
      } else if (mode === "panoptic") {
        svgSemantic.style.display = 'none';
        svgInstance.style.display = 'none';
        svgPanoptic.style.display = 'inline';
      }
    } else {
      labelEl.classList.remove('text-dark');
      labelEl.classList.add('text-muted');
      iconShow.style.display = 'none';
      iconHide.style.display = 'inline';
      eyeShow.style.display = 'none';
      eyeHide.style.display = 'inline';

      svgSemantic.style.display = 'none';
      svgInstance.style.display = 'none';
      svgPanoptic.style.display = 'none';
    }

    // Saat collapse dibuka, tutup collapse lain
    collapseEl.addEventListener('show.bs.collapse', () => {
      console.log('Collapse opened:', collapseId);

      // Tutup semua collapse lain
      toggles.forEach(otherToggle => {
        const otherCollapseId = otherToggle.getAttribute('data-target');
        if (otherCollapseId !== collapseId) {
          const otherCollapseEl = document.querySelector(otherCollapseId);
          if (otherCollapseEl.classList.contains('show')) {
            const bsCollapse = bootstrap.Collapse.getInstance(otherCollapseEl);
            if (bsCollapse) {
              bsCollapse.hide();
            } else {
              new bootstrap.Collapse(otherCollapseEl, { toggle: false }).hide();
            }
          }
        }
      });

      labelEl.classList.remove('text-muted');
      labelEl.classList.add('text-dark');
      iconShow.style.display = 'inline';
      iconHide.style.display = 'none';
      eyeShow.style.display = 'inline';
      eyeHide.style.display = 'none';

      // Tampilkan SVG sesuai mode
      if (mode === "semantic") {
        svgSemantic.style.display = 'inline';
        svgInstance.style.display = 'none';
        svgPanoptic.style.display = 'none';
      } else if (mode === "instance") {
        svgSemantic.style.display = 'none';
        svgInstance.style.display = 'inline';
        svgPanoptic.style.display = 'none';
      } else if (mode === "panoptic") {
        svgSemantic.style.display = 'none';
        svgInstance.style.display = 'none';
        svgPanoptic.style.display = 'inline';
      }
    });

    collapseEl.addEventListener('hide.bs.collapse', () => {
      console.log('Collapse closed:', collapseId);
      labelEl.classList.remove('text-dark');
      labelEl.classList.add('text-muted');
      iconShow.style.display = 'none';
      iconHide.style.display = 'inline';
      eyeShow.style.display = 'none';
      eyeHide.style.display = 'inline';

      svgSemantic.style.display = 'none';
      svgInstance.style.display = 'none';
      svgPanoptic.style.display = 'none';
    });
  });

  // =======================
  // 2. Eye Sub-Bab (tiap item list)
  // =======================
document.querySelectorAll(".eye-show, .eye-hide").forEach(el => {
  el.addEventListener("click", function() {
    const id = this.dataset.id; // ambil id item yang diklik
    const eyeShow = document.getElementById("eye-show-" + id);
    const eyeHide = document.getElementById("eye-hide-" + id);
    const objectEl = document.getElementById("object-" + id); // rect di SVG

    if (!eyeShow || !eyeHide || !objectEl) return; // safety check

    if (eyeShow.style.display === "inline") {
      eyeShow.style.display = "none";
      eyeHide.style.display = "inline";
      objectEl.style.display = "none";
    } else {
      eyeShow.style.display = "inline";
      eyeHide.style.display = "none";
      objectEl.style.display = "inline";
    }
  });
});
});
// Sesuaikan panjang background label agar sesuai teks
document.querySelectorAll("#svgInstance .bbox-group").forEach(group => {
  const textEl = group.querySelector(".label-text");
  const rectEl = group.querySelector(".label-bg");

  // hitung panjang text aktual
  const textLength = textEl.getComputedTextLength();
  rectEl.setAttribute("width", textLength + 8); // + padding
  rectEl.setAttribute("fill", rectEl.dataset.color);
});
document.querySelectorAll("#svgSemantic .semantic-group").forEach(group => {
  const textEl = group.querySelector(".label-text");
  const rectEl = group.querySelector(".label-bg");

  const textLength = textEl.getComputedTextLength();
  rectEl.setAttribute("width", textLength + 8); // + padding
  rectEl.setAttribute("fill", rectEl.dataset.color);
});
document.querySelectorAll("#svgPanoptic .panoptic-group").forEach(group => {
  const textEl = group.querySelector(".label-text");
  const rectEl = group.querySelector(".label-bg");

  const textLength = textEl.getComputedTextLength();
  rectEl.setAttribute("width", textLength + 8); // + padding
  rectEl.setAttribute("fill", rectEl.dataset.color);
});

const zoomInButton = document.getElementById("zoomIn");
const zoomOutButton = document.getElementById("zoomOut");
const zoomFitButton = document.getElementById("zoomFit");
const zoomImage = document.getElementById("zoomImage");
const zoomWrapper = document.getElementById("zoomWrapper");
const svgSemantic = document.getElementById("svgSemantic");
const svgInstance = document.getElementById("svgInstance");
const svgPanoptic = document.getElementById("svgPanoptic");

let scale = 1;

// Zoom In
zoomInButton.addEventListener("click", () => {
  scale += 0.1;
  applyZoom();
});

// Zoom Out
zoomOutButton.addEventListener("click", () => {
  scale -= 0.1;
  if (scale < 0.1) scale = 0.1;
  applyZoom();
});

// Zoom Fit by height
zoomFitButton.addEventListener("click", () => {
  const containerHeight = zoomWrapper.clientHeight;
  const imageHeight = zoomImage.naturalHeight;

  if (imageHeight > 0) {
    scale = containerHeight / imageHeight;
    applyZoom();
  }
});

// Terapkan transformasi
function applyZoom() {
  zoomImage.style.transform = `scale(${scale})`;
  
  [svgSemantic, svgInstance, svgPanoptic].forEach(svg => {
    svg.style.transform = `scale(${scale})`;
    svg.style.transformOrigin = "top left";
  });
  
  // Update canvas for bounding boxes when zoom changes
  setTimeout(() => {
    runDrawing();
  }, 50);
}

</script>

<!-- Add bounding box rendering script similar to label_image.html -->
<script>
  function drawAllAnnotations(annotationsToDraw) {
    const image = document.getElementById('zoomImage');
    const canvas = document.getElementById('annotationCanvas');
    
    if (!image || !canvas || !annotationsToDraw) {
      console.log('Debug: Missing elements for annotation drawing');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('zoomWrapper');
    const rect = image.getBoundingClientRect();
    const wrapperRect = wrapper.getBoundingClientRect();
    
    canvas.width = rect.width;
    canvas.height = rect.height;
    canvas.style.left = (rect.left - wrapperRect.left) + 'px';
    canvas.style.top = (rect.top - wrapperRect.top) + 'px';
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    
    const scaleX = rect.width / image.naturalWidth;
    const scaleY = rect.height / image.naturalHeight;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    annotationsToDraw.forEach((ann, index) => {
      console.log(`Debug: Processing annotation ${index + 1}:`, ann);
      const box = ann.bbox ? ann.bbox : [ann.x_min, ann.y_min, ann.x_max, ann.y_max];
      console.log(`Debug: Box coordinates:`, box);
      const x = box[0] * scaleX;
      const y = box[1] * scaleY;
      const width = (box[2] - box[0]) * scaleX;
      const height = (box[3] - box[1]) * scaleY;
      const label = ann.label;
      const color = ann.is_auto_generated ? '#f59e0b' : '#34D399';
      console.log(`Debug: Drawing box at (${x}, ${y}) with size ${width}x${height}, label: ${label}, color: ${color}`);
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, width, height);
      
      const fontSize = 12;
      ctx.font = `${fontSize}px sans-serif`;
      const textMetrics = ctx.measureText(label);
      
      ctx.fillStyle = color;
      ctx.fillRect(x - 1, y - fontSize - 5, textMetrics.width + 8, fontSize + 4);
      
      ctx.fillStyle = 'white';
      ctx.textBaseline = 'top';
      ctx.fillText(label, x + 3, y - fontSize - 2);
    });
  }
  
  function runDrawing() {
    const initialAnnotations = JSON.parse('{{ annotations_json|safe }}');
    console.log('Debug: Initial annotations data:', initialAnnotations);
    console.log('Debug: Number of annotations:', initialAnnotations.length);
    setTimeout(() => { drawAllAnnotations(initialAnnotations); }, 50);
  }
  
  window.addEventListener('load', function () {
    const image = document.getElementById('zoomImage');
    if (image && image.complete && image.naturalWidth > 0) {
      runDrawing();
    } else if (image) {
      image.onload = runDrawing;
    }
    window.onresize = runDrawing;
  });
</script>
{% endblock %}