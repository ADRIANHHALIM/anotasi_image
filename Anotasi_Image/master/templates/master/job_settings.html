{% extends 'base_master.html' %}
{% load static %}

{% block content %}
<div class="w-full ml-64 p-6">
    <h1 class="text-4xl font-bold mb-6">Job settings</h1>

    <!-- Tab Navigation -->
    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-semibold"
                        data-tab="jobProfile">
                    Job Profile
                </button>
                <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-semibold"
                        data-tab="jobAssign">
                    Job Assign
                </button>
            </nav>
        </div>
    </div>

    <!-- Job Profile Content -->
    <div id="jobProfileContent" class="tab-content active">
        <div class="mb-4 flex justify-between items-center">
            <h3 class="text-xl font-semibold">List Profile</h3>
            <button id="addProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Add Profile
            </button>
        </div>

        <!-- Job Profile List -->
        <div class="grid grid-cols-2 gap-6">
            {% for job in jobs %}
            <div class="bg-white p-6 rounded-lg shadow-md cursor-pointer job-card" 
                onclick="showJobDetail({{ job.id }}, '{{ job.title }}', '{{ job.description }}', '{{ job.hotkey }}', '{{ job.worker_annotator|default:'-' }}', '{{ job.worker_reviewer|default:'-' }}', '{{ job.segmentation_list|join:',' }}')" 
                data-job-id="{{ job.id }}">
                <div class="flex items-start space-x-4">
                    <div class="w-24 h-24 bg-gray-200 rounded-lg overflow-hidden">
                        {% if job.get_first_image_url %}
                            <img src="{{ job.get_first_image_url }}" alt="{{ job.title }}" 
                                 class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold">{{ job.title }}</h4>
                        <div class="space-y-2 text-gray-500">
                            <p class="flex justify-between"><span>Image:</span> <span>{{ job.image_count }}</span></p>
                            <p class="flex justify-between"><span>Date:</span> <span>{{ job.start_date|date:"d M Y" }} - {{ job.end_date|date:"d M Y" }}</span></p>
                            <p class="flex justify-between"><span>Status:</span>
                                <span class="px-2 py-1 rounded-full text-sm
                                    {% if job.status == 'not_assign' %}bg-red-100 text-red-700
                                    {% elif job.status == 'in_progress' %}bg-orange-100 text-orange-700
                                    {% elif job.status == 'finish' %}bg-green-100 text-green-700{% endif %}">
                                    {{ job.get_status_display }}
                                </span>
                            </p>
                            <div class="worker-info space-y-2 text-gray-500">
                                <p class="flex justify-between">
                                    <span>Annotator:</span>
                                    <span>{{ job.worker_annotator|default:'-' }}</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Reviewer:</span>
                                    <span>{{ job.worker_reviewer|default:'-' }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Job Assign Content -->
    <div id="jobAssignContent" class="tab-content hidden">
        <div class="grid grid-cols-2 gap-6">
            {% for job in jobs %}
            <div class="bg-white p-6 rounded-lg shadow-md cursor-pointer job-card"
                onclick="showJobAssignDetail({{ job.id }}); event.stopPropagation();"
                data-job-id="{{ job.id }}">
                <div class="flex items-start space-x-4">
                    <div class="w-24 h-24 bg-gray-200 rounded-lg overflow-hidden">
                        {% if job.get_first_image_url %}
                            <img src="{{ job.get_first_image_url }}" alt="{{ job.title }}" 
                                 class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold">{{ job.title }}</h4>
                        <div class="space-y-2 text-gray-500">
                            <p class="flex justify-between"><span>Image:</span> <span>{{ job.image_count }}</span></p>
                            <p class="flex justify-between"><span>Date:</span> <span>{{ job.start_date|date:"d M Y" }} - {{ job.end_date|date:"d M Y" }}</span></p>
                            <p class="flex justify-between"><span>Status:</span>
                                <span class="px-2 py-1 rounded-full text-sm
                                    {% if job.status == 'not_assign' %}bg-red-100 text-red-700
                                    {% elif job.status == 'in_progress' %}bg-orange-100 text-orange-700
                                    {% elif job.status == 'finish' %}bg-green-100 text-green-700{% endif %}">
                                    {{ job.get_status_display }}
                                </span>
                            </p>
                            <div class="worker-info space-y-2 text-gray-500">
                                <p class="flex justify-between">
                                    <span>Annotator:</span>
                                    <span>{{ job.worker_annotator|default:'-' }}</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Reviewer:</span>
                                    <span>{{ job.worker_reviewer|default:'-' }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Worker Selection Modal -->
<div id="workerSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-2/3 max-h-[80vh] overflow-y-auto relative">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Choose Worker</h2>
                <button type="button" 
                        class="text-gray-500 hover:text-gray-700"
                        onclick="closeWorkerSelection()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Search and Filter -->
            <div class="flex gap-4 mb-6">
                <div class="flex-1">
                    <input type="text"
                           id="workerSearch"
                           placeholder="Search by email/No.hp"
                           class="w-full p-2 border rounded-lg">
                </div>
                <select id="roleFilter" class="p-2 border rounded-lg w-40" disabled>
                    <option value="annotator">Annotator</option>
                    <option value="reviewer">Reviewer</option>
                </select>
            </div>

            <!-- Workers List Section -->
            <div class="space-y-2" id="workersList">
                <div class="p-4 text-gray-500 text-center">
                    Loading workers...
                </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-end mt-6">
                <button type="button"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg mr-2"
                        onclick="closeWorkerSelection()">
                    Cancel
                </button>
                <button id="nextBtn"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                        disabled>
                    Next
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Detail Modal -->
<div id="jobDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-3/4 max-h-[90vh] overflow-y-auto m-auto relative">
        <div class="p-8">
            <!-- Modify the Labeling Progress section -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Labeling Progress</h3>
                    <button onclick="handleAddImage(document.getElementById('detailId').textContent)"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Image
                    </button>
                </div>
                <!-- Keep existing progress boxes -->
                <div class="grid grid-cols-5 gap-4">
                    <!-- Unannotated -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="detailUnannotated">0</div>
                        <div class="text-gray-500 text-center">Unannotated</div>
                    </div>

                    <!-- In Review -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="detailInReview">0</div>
                        <div class="text-gray-500 text-center">In Review</div>
                    </div>

                    <!-- In Rework -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="detailInRework">0</div>
                        <div class="text-gray-500 text-center">In Rework</div>
                    </div>

                    <!-- Finished -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="detailFinished">0</div>
                        <div class="text-gray-500 text-center">Finished</div>
                    </div>

                    <!-- Issues -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="detailIssues">0</div>
                        <div class="text-gray-500 text-center">Issues</div>
                    </div>
                </div>
            </div>

            <!-- Rest of the modal content -->
            <div class="flex justify-between items-start">
                <div class="flex space-x-8 w-full">
                    <!-- Image placeholder -->
                    <div class="w-1/3">
                        <div class="bg-gray-200 w-full aspect-square rounded-lg overflow-hidden">
                            {% if job.get_first_image_url %}
                                <img src="{{ job.get_first_image_url }}" alt="{{ job.title }}" 
                                     class="w-full h-full object-cover">
                            {% endif %}
                        </div>
                    </div>

                    <!-- Job details -->
                    <div class="w-2/3">
                        <h2 id="detailTitle" class="text-2xl font-bold mb-8"></h2>

                        <div class="grid grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <div>
                                    <span class="text-gray-500">ID Job:</span>
                                    <span id="detailId" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Worker Annotator:</span>
                                    <span id="detailAnnotator" class="ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Worker Reviwer:</span>
                                    <span id="detailReviewer" class="ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Deskripsi:</span>
                                    <p id="detailDescription" class="mt-1"></p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Hotkey:</span>
                                    <span id="detailHotkey" class="ml-2">-</span>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="space-y-4">
                                <div>
                                    <span class="text-gray-500">Segmentasi:</span>
                                    <ul id="detailSegmentation" class="mt-1 ml-4 list-disc"></ul>
                                </div>
                                <div>
                                    <span class="text-gray-500">Shape:</span>
                                    <span id="detailShape" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Colour:</span>
                                    <div class="flex items-center mt-1">
                                        <div id="detailColorBox" class="w-6 h-6 rounded mr-2"></div>
                                        <span id="detailColor"></span>
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-500">Time & Date:</span>
                                    <span id="detailDate" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Image:</span>
                                    <span id="detailImageCount" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Status:</span>
                                    <span id="detailStatus" class="ml-2 px-2 py-1 rounded-full text-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Job Assign Detail Modal -->
<div id="jobAssignDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-3/4 max-h-[90vh] overflow-y-auto m-auto relative">
        <div class="p-8">
            <!-- Add a close button in the header -->
            <div class="flex justify-between items-center mb-6">
                <button type="button" 
                        class="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
                        onclick="closeJobAssignModal()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Labeling Progress -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Labeling Progress</h3>
                <div class="grid grid-cols-5 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="assignDetailUnannotated">0</div>
                        <div class="text-gray-500 text-center">Unannotated</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="assignDetailInReview">0</div>
                        <div class="text-gray-500 text-center">In Review</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="assignDetailInRework">0</div>
                        <div class="text-gray-500 text-center">In Rework</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="assignDetailFinished">0</div>
                        <div class="text-gray-500 text-center">Finished</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-4xl font-bold text-center" id="assignDetailIssues">0</div>
                        <div class="text-gray-500 text-center">Issues</div>
                    </div>
                </div>
            </div>

            <!-- Job Details with Assignment Button -->
            <div class="flex justify-between items-start">
                <div class="flex space-x-8 w-full">
                    <!-- Left side with image -->
                    <div class="w-1/3">
                        <div class="bg-gray-200 w-full aspect-square rounded-lg overflow-hidden">
                            {% if job.get_first_image_url %}
                                <img src="{{ job.get_first_image_url }}" alt="{{ job.title }}" 
                                     class="w-full h-full object-cover">
                            {% endif %}
                        </div>
                    </div>

                    <!-- Right side with details -->
                    <div class="w-2/3">
                        <h2 id="assignDetailTitle" class="text-2xl font-bold mb-8"></h2>
                        <div class="grid grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <div>
                                    <span class="text-gray-500">ID Job:</span>
                                    <span id="assignDetailId" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Worker Annotator:</span>
                                    <span id="assignDetailAnnotator" class="ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Worker Reviwer:</span>
                                    <span id="assignDetailReviewer" class="ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Deskripsi:</span>
                                    <p id="assignDetailDescription" class="mt-1"></p>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="space-y-4">
                                <div>
                                    <span class="text-gray-500">Segmentasi:</span>
                                    <ul id="assignDetailSegmentation" class="mt-1 ml-4 list-disc"></ul>
                                </div>
                                <div>
                                    <span class="text-gray-500">Shape:</span>
                                    <span id="assignDetailShape" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Image:</span>
                                    <span id="assignDetailImageCount" class="ml-2"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Status:</span>
                                    <span id="assignDetailStatus" class="ml-2 px-2 py-1 rounded-full text-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom section with Assignment button -->
            <div class="flex justify-end mt-8">
                <!-- Update the Assignment button -->
                <div class="flex justify-end mt-8">
                <button type="button" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                        onclick="showWorkerSelection({{ job.id }})">
                    Assignment
                </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Profile Modal -->
<div id="addProfileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg w-2/3 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Create Profile</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="jobProfileForm" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title <span class="text-red-500">*</span></label>
                        <input type="text" name="title" required class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="description" rows="4" class="w-full p-2 border rounded-md"></textarea>
                    </div>
                </div>

                <!-- Other form fields -->
                <!-- Segmentation Options -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Segmentation <span class="text-red-500">*</span></label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="segmentation" value="semantic" class="mr-2">
                            <span>Semantic</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="segmentation" value="instance" class="mr-2">
                            <span>Instance</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="segmentation" value="panoptic" class="mr-2">
                            <span>Panoptic</span>
                        </label>
                    </div>
                </div>

                <!-- Shape Options -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shape <span class="text-red-500">*</span></label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="shape" value="bounding_box" class="mr-2">
                            <span>Bounding Box</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="shape" value="polygon" class="mr-2">
                            <span>Polygon</span>
                        </label>
                    </div>
                </div>

                <!-- Color Picker -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Color <span class="text-red-500">*</span></label>
                    <input type="color" name="color" required class="w-20 h-10">
                </div>

                <!-- Date Range -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date <span class="text-red-500">*</span></label>
                        <input type="date" name="start_date" required class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date <span class="text-red-500">*</span></label>
                        <input type="date" name="end_date" required class="w-full p-2 border rounded-md">
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelProfileBtn" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .file-input-button {
        position: relative;
        overflow: hidden;
    }

    .file-input-button input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        opacity: 0;
        cursor: pointer;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addProfileBtn = document.getElementById('addProfileBtn');
    const addProfileModal = document.getElementById('addProfileModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const jobProfileForm = document.getElementById('jobProfileForm');

    // Show modal
    addProfileBtn.addEventListener('click', function() {
        addProfileModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    });

    // Hide modal
    function hideModal() {
        addProfileModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        jobProfileForm.reset();
    }

    closeModalBtn.addEventListener('click', hideModal);

    // Close modal when clicking outside
    addProfileModal.addEventListener('click', function(e) {
        if (e.target === addProfileModal) {
            hideModal();
        }
    });

    // Form submission
    jobProfileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("{% url 'master:create_job_profile' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                hideModal();
                window.location.reload();
            } else {
                alert(data.message || 'Error creating job profile');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating job profile');
        });
    });

    // Add click event to job profile cards
    document.querySelectorAll('[data-job-id]').forEach(card => {
        card.addEventListener('click', function() {
            const jobId = this.dataset.jobId;
            const detailModal = document.getElementById('jobDetailModal');

            // Update the fetch URL to use the correct URL pattern
            fetch(`/master/job-profile/${jobId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Accept': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data) {
                    throw new Error('No data received');
                }

                // Update modal content with null checks
                document.getElementById('detailTitle').textContent = data.title || '-';
                document.getElementById('detailId').textContent = data.id || '-';
                document.getElementById('detailAnnotator').textContent = data.worker_annotator || '-';
                document.getElementById('detailReviewer').textContent = data.worker_reviewer || '-';
                document.getElementById('detailDescription').textContent = data.description || '-';
                document.getElementById('detailHotkey').textContent = data.hotkey || '-';

                // Update segmentation list
                const segmentationList = document.getElementById('detailSegmentation');
                segmentationList.innerHTML = '';
                if (data.segmentation_type) {
                    const li = document.createElement('li');
                    li.textContent = data.segmentation_type;
                    segmentationList.appendChild(li);
                }

                document.getElementById('detailShape').textContent = data.shape_type || '-';
                document.getElementById('detailColor').textContent = data.color || '-';
                document.getElementById('detailColorBox').style.backgroundColor = data.color || '#FFFFFF';
                document.getElementById('detailDate').textContent =
                    `${data.start_date || '-'} - ${data.end_date || '-'} WIB`;
                document.getElementById('detailImageCount').textContent = data.image_count || '0';

                // Set status with appropriate styling
                const statusSpan = document.getElementById('detailStatus');
                statusSpan.textContent = data.status || 'Unknown';
                statusSpan.className = 'px-2 py-1 rounded-full text-sm inline-block ' +
                    (data.status === 'not_assign' ? 'bg-red-100 text-red-700' :
                     data.status === 'in_progress' ? 'bg-orange-100 text-orange-700' :
                     'bg-green-100 text-green-700');

                // Update labeling progress
                document.getElementById('detailUnannotated').textContent = data.unannotated_count || '0';
                document.getElementById('detailInReview').textContent = data.in_review_count || '0';
                document.getElementById('detailInRework').textContent = data.in_rework_count || '0';
                document.getElementById('detailFinished').textContent = data.finished_count || '0';
                document.getElementById('detailIssues').textContent = data.issues_count || '0';

                // Show modal
                detailModal.classList.remove('hidden');
                detailModal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            })
            .catch(error => {
                console.error('Error fetching job details:', error);
                // Show a more user-friendly error message
                const errorMessage = 'Unable to load job details. Please try again later.';
                alert(errorMessage);
            });
        });
    });

    // Close detail modal when clicking outside
    document.getElementById('jobDetailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            this.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }
    });
});

// Tab switching functionality
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');

// Set initial state - Mark Job Profile as active by default
document.querySelector('[data-tab="jobProfile"]').classList.add('active', 'border-[#4527A0]', 'text-[#4527A0]');

tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        // Get all modals
        const jobDetailModal = document.getElementById('jobDetailModal');
        const jobAssignModal = document.getElementById('jobAssignDetailModal');
        const addImageModal = document.querySelector('.modal-add-image'); // If exists

        // Hide all modals when switching tabs
        [jobDetailModal, jobAssignModal, addImageModal].forEach(modal => {
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });

        // Remove active class from all buttons and contents
        tabBtns.forEach(b => b.classList.remove('active', 'border-[#4527A0]', 'text-[#4527A0]'));
        tabContents.forEach(c => c.classList.add('hidden'));

        // Add active class to clicked button and show corresponding content
        btn.classList.add('active', 'border-[#4527A0]', 'text-[#4527A0]');
        document.getElementById(`${btn.dataset.tab}Content`).classList.remove('hidden');

        // Handle Add Image button visibility
        const addImageBtn = document.querySelector('[onclick*="handleAddImage"]');
        if (addImageBtn) {
            addImageBtn.style.display = btn.dataset.tab === 'jobProfile' ? 'flex' : 'none';
        }
    });
});

// Modal functions
function showCreateProfile() {
    document.getElementById('createProfileModal').classList.remove('hidden');
}

function hideCreateProfile() {
    document.getElementById('createProfileModal').classList.add('hidden');
}

// Form submission
document.getElementById('createProfileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    // Add your form submission logic here
    hideCreateProfile();
});

function handleAddImage(jobId) {
    const currentImages = parseInt(document.getElementById('detailImageCount').textContent) || 0;
    const maxImages = 150;

    if (currentImages >= maxImages) {
        alert('Maximum number of images (150) has been reached');
        return;
    }

    // Create the modal for image selection
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
    modal.innerHTML = `
        <div class="bg-white rounded-lg w-[80%] h-[80vh] max-h-[70vh] overflow-y-auto relative">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Choose Image</h2>
                    <div class="flex items-center">
                        <span class="text-lg mr-4">${currentImages}/150 Images</span>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Drag & Drop Zone -->
                <div class="mb-6">
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                        <input type="file"
                               id="imageInput"
                               multiple
                               accept="image/*"
                               class="hidden"
                               onchange="handleFiles(this.files, ${maxImages - currentImages}, ${jobId})" />
                        <div class="space-y-4">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4-4m4-12h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="text-gray-600">
                                <p class="font-medium">Drag and drop your images here</p>
                                <p class="text-sm">or</p>
                                <button type="button"
                                        onclick="document.getElementById('imageInput').click()"
                                        class="mt-2 text-blue-500 hover:text-blue-600 font-medium">
                                    Browse files
                                </button>
                            </div>
                            <p class="text-sm text-gray-500">Maximum upload: 150 images (JPG, PNG, JPEG)</p>
                        </div>
                    </div>
                </div>

                <!-- Image Preview Area -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Selected Images</h3>
                    <div id="selectedImagesPreview" class="grid grid-cols-6 gap-4 min-h-[200px] bg-gray-50 p-4 rounded-lg">
                        <!-- Selected images will appear here -->
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex justify-end items-center gap-4 pt-4 border-t">
                    <span class="text-sm text-gray-500" id="selectedCount">0 images selected</span>
                    <button onclick="this.closest('.fixed').remove()"
                            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button id="saveImagesBtn"
                            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                            disabled>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setupDragAndDrop(maxImages - currentImages, jobId);
}

function setupDragAndDrop(remainingSlots, jobId) {
    const dropZone = document.getElementById('dropZone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files, remainingSlots, jobId);
    }
}

function handleFiles(files, remainingSlots, jobId) {
    files = Array.from(files).filter(file => file.type.startsWith('image/'));
    const selectedFiles = []; // Keep track of selected files

    if (files.length > remainingSlots) {
        alert(`You can only select ${remainingSlots} more images`);
        return;
    }

    const previewContainer = document.getElementById('selectedImagesPreview');
    const saveButton = document.getElementById('saveImagesBtn');
    const selectedCountLabel = document.getElementById('selectedCount');
    const imageCountDisplay = document.querySelector('.text-lg.mr-4'); // Count display at top

    // Show previews
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative aspect-square group';
            div.dataset.fileName = file.name; // Store filename for reference
            div.innerHTML = `
                <img src="${e.target.result}" class="w-full h-full object-cover rounded-lg" />
                <div class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                    <button onclick="removeImage(this, '${file.name}')"
                            class="bg-red-500 text-white rounded-full p-2 hover:bg-red-600 focus:outline-none">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate rounded-b-lg">
                    ${file.name}
                </div>
            `;
            previewContainer.appendChild(div);
            selectedFiles.push(file);
            updateImageCount();
        };
        reader.readAsDataURL(file);
    });

    function updateImageCount() {
        const currentCount = previewContainer.children.length;
        const totalCount = parseInt(document.getElementById('detailImageCount').textContent) || 0;
        selectedCountLabel.textContent = `${currentCount} images selected`;
        imageCountDisplay.textContent = `${totalCount + currentCount}/150 Images`;
        saveButton.disabled = currentCount === 0;
    }

    // Add function to remove images
    window.removeImage = function(button, fileName) {
        const imageDiv = button.closest('.relative');
        imageDiv.remove();
        const index = selectedFiles.findIndex(file => file.name === fileName);
        if (index > -1) {
            selectedFiles.splice(index, 1);
        }
        updateImageCount();
    };

    // Update save button click handler
    saveButton.onclick = function() {
        uploadImages(selectedFiles, jobId);
    };
}

function uploadImages(files, jobId) {
    const formData = new FormData();
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    files.forEach(file => {
        formData.append('images[]', file);
    });
    formData.append('job_id', jobId);

    // Show loading state
    const saveButton = document.getElementById('saveImagesBtn');
    const modal = saveButton.closest('.fixed'); // Find the modal container

    saveButton.disabled = true;
    saveButton.textContent = 'Uploading...';

    fetch('/master/upload-job-images/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            // Update image counts
            document.getElementById('detailImageCount').textContent = data.new_image_count;

            // Update Labeling Progress counts
            document.getElementById('detailUnannotated').textContent = data.new_image_count; // All new images are unannotated
            document.getElementById('detailInReview').textContent = data.in_review_count || '0';
            document.getElementById('detailInRework').textContent = data.in_rework_count || '0';
            document.getElementById('detailFinished').textContent = data.finished_count || '0';
            document.getElementById('detailIssues').textContent = data.issues_count || '0';

            // Update job card in the list
            const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (jobCard) {
                const imageCountEl = jobCard.querySelector('.text-gray-500 span:last-child');
                if (imageCountEl) {
                    imageCountEl.textContent = data.new_image_count;
                }

                // Update status if changed
                if (data.new_status) {
                    const statusEl = jobCard.querySelector('.rounded-full');
                    if (statusEl) {
                        statusEl.textContent = data.new_status;
                        // Update status styling
                        statusEl.className = `px-2 py-1 rounded-full text-sm ${
                            data.new_status === 'not_assign' ? 'bg-red-100 text-red-700' :
                            data.new_status === 'in_progress' ? 'bg-orange-100 text-orange-700' :
                            'bg-green-100 text-green-700'
                        }`;
                    }
                }
            }

            // Close modal and show success message
            if (modal) {
                modal.remove();
            }
            alert(data.message);
        } else {
            throw new Error(data.message || 'Error uploading images');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error uploading images: ${error.message}`);
        saveButton.disabled = false;
        saveButton.textContent = 'Save Changes';
    });
}

function showJobAssignDetail(jobId) {
    const jobAssignModal = document.getElementById('jobAssignDetailModal');
    
    // Prevent event bubbling
    event?.stopPropagation();
    
    // Add click event listener for background click
    jobAssignModal.addEventListener('click', function(event) {
        if (event.target === jobAssignModal) {
            closeJobAssignModal();
            // Prevent event from bubbling up
            event.stopPropagation();
        }
    });

    fetch(`/master/job-profile/${jobId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Accept': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Update assign modal content
        document.getElementById('assignDetailTitle').textContent = data.title;
        document.getElementById('assignDetailId').textContent = data.id;
        document.getElementById('assignDetailAnnotator').textContent = data.worker_annotator || '-';
        document.getElementById('assignDetailReviewer').textContent = data.worker_reviewer || '-';
        document.getElementById('assignDetailDescription').textContent = data.description;

        // Update segmentation list
        const segmentationList = document.getElementById('assignDetailSegmentation');
        segmentationList.innerHTML = '';
        if (data.segmentation_type) {
            const li = document.createElement('li');
            li.textContent = data.segmentation_type;
            segmentationList.appendChild(li);
        }

        document.getElementById('assignDetailShape').textContent = data.shape_type;
        document.getElementById('assignDetailImageCount').textContent = data.image_count;

        // Update status with styling
        const statusSpan = document.getElementById('assignDetailStatus');
        statusSpan.textContent = data.status;
        statusSpan.className = `px-2 py-1 rounded-full text-sm ${
            data.status === 'not_assign' ? 'bg-red-100 text-red-700' :
            data.status === 'in_progress' ? 'bg-orange-100 text-orange-700' :
            'bg-green-100 text-green-700'
        }`;

        // Update labeling progress
        document.getElementById('assignDetailUnannotated').textContent = data.unannotated_count || '0';
        document.getElementById('assignDetailInReview').textContent = data.in_review_count || '0';
        document.getElementById('assignDetailInRework').textContent = data.in_rework_count || '0';
        document.getElementById('assignDetailFinished').textContent = data.finished_count || '0';
        document.getElementById('assignDetailIssues').textContent = data.issues_count || '0';

        // Update the Assignment button to use a direct click handler
        const assignBtn = jobAssignModal.querySelector('button[onclick*="showWorkerSelection"]');
        if (assignBtn) {
            assignBtn.onclick = () => {
                const jobId = document.getElementById('assignDetailId').textContent;
                showWorkerSelection(jobId);
            };
        }

        // Show the modal
        jobAssignModal.classList.remove('hidden');
        jobAssignModal.classList.add('flex');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading job details');
    });
}

let selections = {}; // Global selections object

function submitAssignments(jobId, annotatorId, reviewerId) {
    if (!jobId || !annotatorId || !reviewerId) {
        alert('Please select both annotator and reviewer');
        return;
    }

    const data = {
        job_id: parseInt(jobId),
        annotator_id: parseInt(annotatorId),
        reviewer_id: parseInt(reviewerId)
    };

    fetch('/master/assign-workers/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update job cards in both tabs
            const jobCards = document.querySelectorAll(`[data-job-id="${jobId}"]`);
            jobCards.forEach(card => {
                const workerInfo = card.querySelector('.worker-info');
                if (workerInfo) {
                    workerInfo.innerHTML = `
                        <p class="flex justify-between">
                            <span>Annotator:</span>
                            <span>${data.annotator_name}</span>
                        </p>
                        <p class="flex justify-between">
                            <span>Reviewer:</span>
                            <span>${data.reviewer_name}</span>
                        </p>
                    `;
                }

                // Update status
                const statusEl = card.querySelector('.rounded-full');
                if (statusEl) {
                    statusEl.textContent = data.new_status;
                    statusEl.className = `px-2 py-1 rounded-full text-sm ${
                        data.new_status === 'not_assign' ? 'bg-red-100 text-red-700' :
                        data.new_status === 'in_progress' ? 'bg-orange-100 text-orange-700' :
                        'bg-green-100 text-green-700'
                    }`;
                }
            });

            // Update worker info in detail modal
            const detailAnnotator = document.getElementById('detailAnnotator');
            const detailReviewer = document.getElementById('detailReviewer');
            if (detailAnnotator) detailAnnotator.textContent = data.annotator_name;
            if (detailReviewer) detailReviewer.textContent = data.reviewer_name;

            // Update worker info in assign modal
            const assignDetailAnnotator = document.getElementById('assignDetailAnnotator');
            const assignDetailReviewer = document.getElementById('assignDetailReviewer');
            if (assignDetailAnnotator) assignDetailAnnotator.textContent = data.annotator_name;
            if (assignDetailReviewer) assignDetailReviewer.textContent = data.reviewer_name;

            // Close worker selection modal
            const workerSelectionModal = document.getElementById('workerSelectionModal');
            const jobAssignModal = document.getElementById('jobAssignDetailModal');

            workerSelectionModal.classList.add('hidden');
            workerSelectionModal.classList.remove('flex');

            // Show job assign modal with updated info
            jobAssignModal.classList.remove('hidden');
            jobAssignModal.classList.add('flex');

            // Show success message
            alert('Workers assigned successfully');
        } else {
            throw new Error(data.message || 'Error assigning workers');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Error assigning workers. Please try again.');
    });
}

// Update showWorkerSelection to properly initialize selections
function showWorkerSelection(jobId) {
    console.log('showWorkerSelection called with jobId:', jobId);
    
    if (!jobId) {
        console.error('No job ID provided');
        return;
    }

    // Reset selections and set initial step
    window.selections = {};
    window.currentStep = 'annotator';

    // Get modals
    const workerSelectionModal = document.getElementById('workerSelectionModal');
    const jobAssignModal = document.getElementById('jobAssignDetailModal');
    if (jobAssignModal) {
        jobAssignModal.classList.add('hidden');
        jobAssignModal.classList.remove('flex');
    }
    const jobDetailModal = document.getElementById('jobDetailModal');

    // Hide other modals
    [jobAssignModal, jobDetailModal].forEach(modal => {
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });

    // Update modal content
    const title = workerSelectionModal.querySelector('h2');
    const roleFilter = document.getElementById('roleFilter');
    const nextBtn = document.getElementById('nextBtn');
    const workersList = document.getElementById('workersList');

    if (title) title.textContent = 'Choose Annotator';
    if (roleFilter) {
        roleFilter.value = 'annotator';
        roleFilter.disabled = true;
    }
    if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'Next';
        
        // Set up next button click handler
        nextBtn.onclick = () => {
            if (window.currentStep === 'annotator') {
                // Move to reviewer selection
                window.currentStep = 'reviewer';
                title.textContent = 'Choose Reviewer';
                roleFilter.value = 'reviewer';
                nextBtn.textContent = 'Finish';
                nextBtn.disabled = true;
                // Clear previous selections in the UI
                const radios = workersList.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => radio.checked = false);
                // Fetch reviewers
                fetchWorkers('reviewer');
            } else {
                // Submit final selections
                submitAssignments(jobId, window.selections.annotator, window.selections.reviewer);
            }
        };
    }

    // Show loading state
    if (workersList) {
        workersList.innerHTML = '<div class="p-4 text-gray-500 text-center">Loading workers...</div>';
    }

    // Show worker selection modal
    workerSelectionModal.classList.remove('hidden');
    workerSelectionModal.classList.add('flex');

    // Fetch initial workers
    fetchWorkers('annotator');
}
// Update handleWorkerSelection function
function handleWorkerSelection(workerId) {
    console.log('Worker selected:', workerId);
    
    const nextBtn = document.getElementById('nextBtn');
    const currentStep = document.querySelector('#workerSelectionModal h2')
        .textContent.toLowerCase()
        .includes('annotator') ? 'annotator' : 'reviewer';

    // Update radio button state
    const radioButtons = document.querySelectorAll('input[name="selected_worker"]');
    radioButtons.forEach(radio => {
        radio.checked = radio.value === workerId.toString();
    });

    // Store selection
    window.selections[currentStep] = workerId;
    
    // Enable next button
    if (nextBtn) {
        nextBtn.disabled = false;
    }

    console.log('Current selections:', window.selections);
}

// Add close button functionality
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Job Assign Modal close handler
    const jobAssignModal = document.getElementById('jobAssignDetailModal');
    if (jobAssignModal) {
        // Add close button to modal header
        const closeButton = document.createElement('button');
        closeButton.className = 'absolute top-4 right-4 text-gray-500 hover:text-gray-700';
        closeButton.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        `;
        closeButton.onclick = () => closeAllModals();
        
        const header = jobAssignModal.querySelector('.p-8');
        if (header) {
            header.insertBefore(closeButton, header.firstChild);
        }

        // Background click handler
        jobAssignModal.addEventListener('click', function(event) {
            if (event.target === jobAssignModal) {
                closeAllModals();
            }
        });
    }

    const workerSelectionModal = document.getElementById('workerSelectionModal');
    if (workerSelectionModal) {
        // Update cancel button
        const cancelBtn = workerSelectionModal.querySelector('button[onclick="closeWorkerSelection()"]');
        if (cancelBtn) {
            cancelBtn.onclick = (e) => {
                e.preventDefault();
                closeWorkerSelection();
            };
        }

        // Background click handler
        workerSelectionModal.addEventListener('click', function(event) {
            if (event.target === workerSelectionModal) {
                closeWorkerSelection();
            }
        });

        // Close button in header
        const closeBtn = workerSelectionModal.querySelector('button.text-gray-500');
        if (closeBtn) {
            closeBtn.onclick = (e) => {
                e.preventDefault();
                closeWorkerSelection();
            };
        }
    }
});

// Update the fetchWorkers function
function fetchWorkers(role) {
    console.log('Fetching workers for role:', role);
    
    const workersList = document.getElementById('workersList');
    if (!workersList) return;

    // Show loading state
    workersList.innerHTML = '<div class="p-4 text-gray-500 text-center">Loading workers...</div>';

    fetch(`/master/get-workers/${role}/`, {
        headers: {
            'Accept': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (!data.workers || data.workers.length === 0) {
            workersList.innerHTML = '<div class="p-4 text-gray-500">No workers available for this role</div>';
            return;
        }

        workersList.innerHTML = data.workers.map(worker => `
            <div class="worker-item bg-white rounded-lg shadow-sm hover:bg-gray-50 transition-colors cursor-pointer p-4"
                 onclick="handleWorkerSelection(${worker.id})">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gray-200 rounded-full"></div>
                        <div>
                            <div class="font-medium">${worker.email}</div>
                            <div class="text-sm text-gray-500">${worker.phone || 'No phone'}</div>
                        </div>
                    </div>
                    <input type="radio" name="selected_worker" value="${worker.id}" 
                           class="form-radio h-5 w-5 text-blue-600">
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('Error fetching workers:', error);
        workersList.innerHTML = '<div class="p-4 text-red-500">Error loading workers. Please try again.</div>';
    });
}

function handleWorkerSelection(workerId) {
    console.log('Worker selected:', workerId);
    
    const nextBtn = document.getElementById('nextBtn');
    const currentStep = document.querySelector('#workerSelectionModal h2')
        .textContent.toLowerCase()
        .includes('annotator') ? 'annotator' : 'reviewer';

    // Update radio button state
    const radioButtons = document.querySelectorAll('input[name="selected_worker"]');
    radioButtons.forEach(radio => {
        radio.checked = radio.value === workerId.toString();
    });

    // Store selection
    window.selections[currentStep] = workerId;
    
    // Enable next button
    if (nextBtn) {
        nextBtn.disabled = false;
    }

    console.log('Current selections:', window.selections);
}

// Add this to your document ready event listener
document.addEventListener('DOMContentLoaded', function() {
    const assignmentBtns = document.querySelectorAll('[onclick*="showWorkerSelection"]');
    console.log('Found assignment buttons:', assignmentBtns.length);

    // Remove the event listeners that might interfere with the onclick attribute
    // Instead, we'll ensure the onclick attribute works correctly

    // Check if the worker selection modal exists
    const workerSelectionModal = document.getElementById('workerSelectionModal');
    if (!workerSelectionModal) {
        console.error('Worker selection modal not found');
    }
});

// Add a general close modal function
function closeAllModals() {
    const modals = ['workerSelectionModal', 'jobAssignDetailModal', 'jobDetailModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });
}

function closeWorkerSelection() {
    console.log('Closing worker selection modal');
    const workerSelectionModal = document.getElementById('workerSelectionModal');
    const jobAssignModal = document.getElementById('jobAssignDetailModal');
    
    if (workerSelectionModal) {
        workerSelectionModal.classList.add('hidden');
        workerSelectionModal.classList.remove('flex');
    }
    
    // Show job assign modal again
    if (jobAssignModal) {
        jobAssignModal.classList.remove('hidden');
        jobAssignModal.classList.add('flex');
    }
}

function closeJobAssignModal() {
    const jobAssignModal = document.getElementById('jobAssignDetailModal');
    const jobDetailModal = document.getElementById('jobDetailModal');
    
    // Close job assign modal
    if (jobAssignModal) {
        jobAssignModal.classList.add('hidden');
        jobAssignModal.classList.remove('flex');
    }
    
    // Ensure job detail modal stays hidden
    if (jobDetailModal) {
        jobDetailModal.classList.add('hidden');
        jobDetailModal.classList.remove('flex');
    }

    // Stop event propagation to prevent other modals from showing
    event?.stopPropagation();
}

// Update the click handler in the job card
function showJobAssignDetail(jobId) {
    const jobAssignModal = document.getElementById('jobAssignDetailModal');
    
    // Prevent event bubbling
    event?.stopPropagation();
    
    // Add click event listener for background click
    jobAssignModal.addEventListener('click', function(event) {
        if (event.target === jobAssignModal) {
            closeJobAssignModal();
            // Prevent event from bubbling up
            event.stopPropagation();
        }
    });

    fetch(`/master/job-profile/${jobId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Accept': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Update assign modal content
        document.getElementById('assignDetailTitle').textContent = data.title;
        document.getElementById('assignDetailId').textContent = data.id;
        document.getElementById('assignDetailAnnotator').textContent = data.worker_annotator || '-';
        document.getElementById('assignDetailReviewer').textContent = data.worker_reviewer || '-';
        document.getElementById('assignDetailDescription').textContent = data.description;

        // Update segmentation list
        const segmentationList = document.getElementById('assignDetailSegmentation');
        segmentationList.innerHTML = '';
        if (data.segmentation_type) {
            const li = document.createElement('li');
            li.textContent = data.segmentation_type;
            segmentationList.appendChild(li);
        }

        document.getElementById('assignDetailShape').textContent = data.shape_type;
        document.getElementById('assignDetailImageCount').textContent = data.image_count;

        // Update status with styling
        const statusSpan = document.getElementById('assignDetailStatus');
        statusSpan.textContent = data.status;
        statusSpan.className = `px-2 py-1 rounded-full text-sm ${
            data.status === 'not_assign' ? 'bg-red-100 text-red-700' :
            data.status === 'in_progress' ? 'bg-orange-100 text-orange-700' :
            'bg-green-100 text-green-700'
        }`;

        // Update labeling progress
        document.getElementById('assignDetailUnannotated').textContent = data.unannotated_count || '0';
        document.getElementById('assignDetailInReview').textContent = data.in_review_count || '0';
        document.getElementById('assignDetailInRework').textContent = data.in_rework_count || '0';
        document.getElementById('assignDetailFinished').textContent = data.finished_count || '0';
        document.getElementById('assignDetailIssues').textContent = data.issues_count || '0';

        // Update the Assignment button to use a direct click handler
        const assignBtn = jobAssignModal.querySelector('button[onclick*="showWorkerSelection"]');
        if (assignBtn) {
            assignBtn.onclick = () => {
                const jobId = document.getElementById('assignDetailId').textContent;
                showWorkerSelection(jobId);
            };
        }

        // Show the modal
        jobAssignModal.classList.remove('hidden');
        jobAssignModal.classList.add('flex');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading job details');
    });
}
</script>
{% endblock %}